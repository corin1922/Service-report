<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>JW Service</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --purple: #745699;
    --purple-dark: #5a3d80;
    --purple-light: #9b7cc0;
    --purple-bg: #745699;
    --purple-card: #745699;
    --gray-bg: #f2f2f7;
    --border: #ddd;
    --text: #1c1c1e;
    --text-sub: #6e6e73;
    --white: #ffffff;
    --red: #e53935;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
    background: var(--gray-bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  .header {
    background: var(--purple-bg);
    padding: 11px 16px 9px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    color: white;
    font-size: 19px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }
  .header-icon {
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }
  .header-user {
    color: rgba(255,255,255,0.85);
    font-size: 12px;
    margin-top: 2px;
  }

  /* TABS */
  .tabs {
    display: flex;
    background: white;
    border-bottom: 1px solid var(--border);
  }
  .tab {
    flex: 1;
    padding: 9px 0;
    text-align: center;
    font-size: 14px;
    color: var(--text-sub);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    font-weight: 400;
  }
  .tab.active {
    color: var(--purple);
    border-bottom: 2px solid var(--purple);
    font-weight: 600;
  }

  /* TAB CONTENT */
  .tab-content { display: none; padding: 10px 12px; }
  .tab-content.active { display: block; }

  /* CARDS */
  .card {
    background: white;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .card-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--purple);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* FORM ELEMENTS */
  label {
    display: block;
    font-size: 13px;
    color: var(--text);
    margin-bottom: 4px;
    margin-top: 8px;
  }
  label:first-child { margin-top: 0; }

  input[type="text"], input[type="date"], select, textarea {
    width: 100%;
    padding: 9px 12px;
    border: 1px solid var(--border);
    border-radius: 9px;
    font-size: 15px;
    color: var(--text);
    background: white;
    -webkit-appearance: none;
    appearance: none;
    outline: none;
    font-family: inherit;
  }
  input[type="date"] {
    text-align: center;
    font-size: 15px;
  }
  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23666' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 32px;
    cursor: pointer;
  }
  textarea {
    min-height: 70px;
    resize: vertical;
  }

  .row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  /* BUTTONS */
  .btn {
    width: 100%;
    padding: 11px;
    border: none;
    border-radius: 9px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
    font-family: inherit;
  }
  .btn-primary { background: #3a86c8; color: white; }
  .btn-primary:active { background: #2a6aa8; }
  .btn-danger { background: var(--red); color: white; }
  .btn-cancel { background: #f2f2f2; color: var(--text); border: 1px solid var(--border); }

  /* STATS CARD (purple) */
  .stats-card {
    background: var(--purple-card);
    border-radius: 12px;
    padding: 14px 12px;
    margin-bottom: 10px;
    color: white;
    text-align: center;
  }
  .stats-card .month-select-row {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 12px;
  }
  .stats-card select {
    background: white;
    color: var(--purple);
    border: 1px solid white;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 14px;
    font-weight: 600;
    width: auto;
    -webkit-appearance: none;
    appearance: none;
    background-image: none;
    cursor: pointer;
    text-align: center;
  }
  .stats-card select option { background: var(--purple-dark); color: white; }
  .stats-row {
    display: flex;
    justify-content: space-around;
    margin-bottom: 12px;
  }
  .stats-item label { color: rgba(255,255,255,0.8); font-size: 12px; margin: 0 0 2px 0; }
  .stats-item .num { font-size: 44px; font-weight: 700; line-height: 1; }

  /* RADIO LANG */
  .lang-row {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-bottom: 10px;
  }
  .lang-row label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
    color: white;
    cursor: pointer;
    margin: 0;
  }
  .lang-row input[type="radio"] {
    width: 16px;
    height: 16px;
    accent-color: #3a86c8;
    cursor: pointer;
  }

  .btn-send {
    background: #ff8c00;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px;
    font-size: 15px;
    font-weight: 600;
    width: 100%;
    cursor: pointer;
    font-family: inherit;
  }
  .btn-send:active { background: #eee; }

  /* SERVICE YEAR CARD */
  .year-card {
    background: var(--purple-card);
    border-radius: 12px;
    padding: 18px 16px;
    text-align: center;
    color: white;
  }
  .year-card .year-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .year-card .year-num { font-size: 52px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
  .year-card .year-sub { font-size: 13px; color: rgba(255,255,255,0.8); }

  /* CALENDAR */
  .cal-header {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
  }
  .cal-header select {
    flex: 1;
  }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }
  .cal-day-label {
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    padding: 4px 0 8px;
    color: var(--text-sub);
  }
  .cal-day-label.sun { color: #e53935; }
  .cal-day-label.sat { color: #1976d2; }

  .cal-day {
    border-radius: 8px;
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    padding: 2px;
    transition: background 0.15s;
    min-height: 44px;
  }
  .cal-day:active { opacity: 0.7; }
  .cal-day.empty { cursor: default; }
  .cal-day.has-record {
    background: var(--purple);
    color: white;
    font-weight: 700;
  }
  .cal-day.has-record.today { box-shadow: 0 0 0 2px white, 0 0 0 4px var(--purple); }
  .cal-day.today:not(.has-record) { font-weight: 700; color: var(--purple); }
  .cal-day .day-num { font-size: 13px; line-height: 1; }
  .cal-day .day-info { font-size: 9px; line-height: 1.3; text-align: center; margin-top: 2px; }
  .cal-day.has-record .day-info { color: rgba(255,255,255,0.9); }
  .cal-day .day-study { color: #ffd54f; font-size: 9px; }

  /* REVISIT LIST */
  .revisit-item {
    display: flex;
    align-items: center;
    padding: 13px 0;
    border-bottom: 1px solid #f0f0f0;
    gap: 8px;
  }
  .revisit-item:last-child { border-bottom: none; }
  .revisit-name { flex: 1; font-size: 16px; font-weight: 500; }
  .btn-sm {
    padding: 7px 14px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: white;
    font-family: inherit;
  }
  .btn-sm.danger { color: var(--red); border-color: #fcc; }
  .btn-sm.primary { color: var(--purple); border-color: #d5b8f0; }

  /* MODAL */
  .modal-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-backdrop.open { display: flex; }
  .modal {
    background: white;
    border-radius: 14px;
    padding: 20px;
    width: 100%;
    max-width: 360px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  }
  .modal-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--text-sub);
    line-height: 1;
    padding: 0;
  }
  .modal-btns {
    display: flex;
    gap: 10px;
    margin-top: 16px;
  }
  .modal-btns .btn {
    flex: 1;
    margin-top: 0;
    padding: 12px;
    font-size: 15px;
  }

  /* CHECKBOX */
  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 0;
    cursor: pointer;
    font-size: 15px;
    color: var(--text);
  }
  .checkbox-row input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--purple);
    cursor: pointer;
  }

  /* MONTHLY SUMMARY */
  .summary-box {
    background: #f8f4ff;
    border-radius: 10px;
    padding: 14px;
    margin-top: 12px;
    text-align: center;
  }
  .summary-box .s-title {
    color: var(--purple);
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 10px;
  }
  .summary-box .s-row {
    display: flex;
    justify-content: space-around;
  }
  .summary-box .s-item label { font-size: 12px; color: var(--text-sub); margin: 0 0 2px; }
  .summary-box .s-item .s-num { font-size: 22px; font-weight: 700; color: var(--purple); }

  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(0);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-size: 14px;
    font-weight: 500;
    z-index: 999;
    opacity: 0;
    transition: opacity 0.3s;
    white-space: nowrap;
    pointer-events: none;
  }
  .toast.show { opacity: 1; }

  /* TOKEN SETUP SCREEN */
  .token-screen {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--gray-bg);
    z-index: 500;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .token-screen.show { display: flex; }
  .token-box {
    background: white;
    border-radius: 16px;
    padding: 28px 20px;
    width: 100%;
    max-width: 380px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    text-align: center;
  }
  .token-box .t-icon { font-size: 36px; margin-bottom: 10px; }
  .token-box .t-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--purple);
    margin-bottom: 6px;
  }
  .token-box .t-desc {
    font-size: 13px;
    color: var(--text-sub);
    margin-bottom: 20px;
    line-height: 1.5;
  }
  .token-box input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 9px;
    font-size: 13px;
    font-family: monospace;
    margin-bottom: 12px;
    outline: none;
  }
  .token-box input:focus { border-color: var(--purple); }
  .token-box .t-note {
    font-size: 11px;
    color: var(--text-sub);
    margin-top: 10px;
    line-height: 1.5;
  }
  .header { position: relative; }
  .header-reset {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: #e53935;
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 11px;
    padding: 4px 8px;
    cursor: pointer;
    font-family: inherit;
  }
</style>
</head>
<body>

<!-- TOKEN SETUP SCREEN -->
<div class="token-screen" id="tokenScreen">
  <div class="token-box">
    <div class="t-icon">ğŸ”‘</div>
    <div class="t-title">GitHub í† í° ì…ë ¥</div>
    <div class="t-desc">ë°ì´í„°ë¥¼ ì €ì¥í•˜ë ¤ë©´ GitHub Personal Access Tokenì´ í•„ìš”í•´ìš”.<br>í•œ ë²ˆë§Œ ì…ë ¥í•˜ë©´ ì´ ê¸°ê¸°ì—ì„œëŠ” ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë¼ìš”.</div>
    <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
    <button class="btn btn-primary" style="margin-top:0" onclick="saveToken()">ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    <div class="t-note">âš ï¸ í† í°ì€ ì´ ê¸°ê¸°ì—ë§Œ ì €ì¥ë˜ë©° GitHubì— ì—…ë¡œë“œë˜ì§€ ì•Šì•„ìš”.<br>Settings â†’ Developer settings â†’ Personal access tokensì—ì„œ ë°œê¸‰í•˜ì„¸ìš”.</div>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-title">
    <div class="header-icon"><img src="apple-touch-icon.png" style="width:24px;height:24px;border-radius:6px;display:block;"></div>
    JW Service
  </div>
  <div class="header-user" id="headerUser">ë¡œë”© ì¤‘...</div>
  <button class="header-reset" onclick="resetToken()">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('home')">í™ˆ</div>
  <div class="tab" onclick="switchTab('calendar')">ìº˜ë¦°ë”</div>
  <div class="tab" onclick="switchTab('revisit')">ì¬ë°©ë¬¸ ê¸°ë¡</div>
</div>

<!-- ===== HOME TAB ===== -->
<div id="tab-home" class="tab-content active">

  <!-- ì˜¤ëŠ˜ì˜ ë´‰ì‚¬ ê¸°ë¡ -->
  <div class="card">
    <div class="card-title">ğŸ“ ì˜¤ëŠ˜ì˜ ë´‰ì‚¬ ê¸°ë¡</div>
    <label>ë‚ ì§œ</label>
    <input type="date" id="recordDate">

    <label>ë´‰ì‚¬ ì‹œê°„</label>
    <div class="row-2">
      <select id="recordHour">
        <script>for(let i=0;i<=23;i++) document.write(`<option value="${i}">${i}ì‹œê°„</option>`);</script>
      </select>
      <select id="recordMin">
        <script>for(let i=0;i<12;i++) document.write(`<option value="${i*5}">${i*5}ë¶„</option>`);</script>
      </select>
    </div>

    <label>ì„±ì„œ ì—°êµ¬</label>
    <select id="recordStudy">
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <script>for(let i=1;i<=20;i++) document.write(`<option value="${i}">${i}ëª…</option>`);</script>
    </select>

    <button class="btn btn-primary" onclick="saveRecord()">ë´‰ì‚¬ ê¸°ë¡ ì €ì¥</button>
  </div>

  <!-- ì›” í†µê³„ + ì „ì†¡ -->
  <div class="stats-card">
    <div class="month-select-row">
      <select id="statsYear" onchange="renderStats()"></select>
      <select id="statsMonth" onchange="renderStats()"></select>
    </div>
    <div class="stats-row">
      <div class="stats-item">
        <label>ì‹œê°„</label>
        <div class="num" id="statHours">0</div>
      </div>
      <div class="stats-item">
        <label>ì„±ì„œ ì—°êµ¬</label>
        <div class="num" id="statStudy">0</div>
      </div>
    </div>
    <div class="lang-row">
      <label><input type="radio" name="lang" value="ko" checked> í•œêµ­ì–´</label>
      <label><input type="radio" name="lang" value="en"> English</label>
      <label><input type="radio" name="lang" value="id"> Indonesia</label>
    </div>
    <button class="btn-send" onclick="sendReport()">ì „ì†¡</button>
  </div>

  <!-- ë´‰ì‚¬ ì—°ë„ -->
  <div class="year-card">
    <div class="year-title" id="serviceYearTitle">2026 ë´‰ì‚¬ ì—°ë„</div>
    <div class="year-num" id="serviceYearHours">0</div>
    <div class="year-sub">ì´ ë´‰ì‚¬ ì‹œê°„</div>
  </div>
</div>

<!-- ===== CALENDAR TAB ===== -->
<div id="tab-calendar" class="tab-content">

  <div class="card">
    <div class="card-title">ğŸ“… ë‹¬ë ¥</div>
    <div class="cal-header">
      <select id="calYear" onchange="renderCalendar()"></select>
      <select id="calMonth" onchange="renderCalendar()"></select>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“Š ì›”ë³„ ê¸°ë¡ ì¡°íšŒ</div>
    <label>ë…„ë„</label>
    <select id="summaryYear"></select>
    <label>ì›”</label>
    <select id="summaryMonth"></select>
    <button class="btn btn-primary" onclick="showMonthlySummary()">ì›”ë³„ ìš”ì•½ ë³´ê¸°</button>
    <div id="summaryResult" style="display:none" class="summary-box">
      <div class="s-title" id="summaryTitle"></div>
      <div class="s-row">
        <div class="s-item">
          <label>ì´ ë´‰ì‚¬ ì‹œê°„</label>
          <div class="s-num" id="summaryHours">0</div>
        </div>
        <div class="s-item">
          <label>ì´ ì„±ì„œ ì—°êµ¬</label>
          <div class="s-num" id="summaryStudy">0</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== REVISIT TAB ===== -->
<div id="tab-revisit" class="tab-content">

  <div class="card">
    <div class="card-title">+ ì¬ë°©ë¬¸ ì •ë³´ ì…ë ¥</div>
    <label>ì´ë¦„</label>
    <input type="text" id="rvName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    <label>ë©”ëª¨</label>
    <textarea id="rvMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <label class="checkbox-row" style="margin-top:12px">
      <input type="checkbox" id="rvStudy"> ì„±ì„œ ì—°êµ¬
    </label>
    <button class="btn btn-primary" onclick="saveRevisit()">ì¬ë°©ë¬¸ ì •ë³´ ì €ì¥</button>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“‹ ì¬ë°©ë¬¸ ëª©ë¡</div>
    <div id="revisitList"></div>
  </div>
</div>

<!-- EDIT RECORD MODAL -->
<div class="modal-backdrop" id="editRecordModal">
  <div class="modal">
    <div class="modal-title">
      ë´‰ì‚¬ ê¸°ë¡ ìˆ˜ì •
      <button class="modal-close" onclick="closeModal('editRecordModal')">Ã—</button>
    </div>
    <label>ë‚ ì§œ</label>
    <input type="date" id="editDate" readonly style="background:#f5f5f5;color:#999">
    <label>ë´‰ì‚¬ ì‹œê°„</label>
    <div class="row-2">
      <select id="editHour">
        <script>for(let i=0;i<=23;i++) document.write(`<option value="${i}">${i}ì‹œê°„</option>`);</script>
      </select>
      <select id="editMin">
        <script>for(let i=0;i<12;i++) document.write(`<option value="${i*5}">${i*5}ë¶„</option>`);</script>
      </select>
    </div>
    <label>ì„±ì„œ ì—°êµ¬</label>
    <select id="editStudy">
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <script>for(let i=1;i<=20;i++) document.write(`<option value="${i}">${i}ëª…</option>`);</script>
    </select>
    <div class="modal-btns">
      <button class="btn btn-cancel" onclick="closeModal('editRecordModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="updateRecord()">ì €ì¥</button>
      <button class="btn btn-danger" onclick="deleteRecord()">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- EDIT REVISIT MODAL -->
<div class="modal-backdrop" id="editRevisitModal">
  <div class="modal">
    <div class="modal-title">
      ì¬ë°©ë¬¸ ì •ë³´ ìˆ˜ì •
      <button class="modal-close" onclick="closeModal('editRevisitModal')">Ã—</button>
    </div>
    <label>ì´ë¦„</label>
    <input type="text" id="editRvName">
    <label>ë©”ëª¨</label>
    <textarea id="editRvMemo"></textarea>
    <label class="checkbox-row" style="margin-top:12px">
      <input type="checkbox" id="editRvStudy"> ì„±ì„œ ì—°êµ¬
    </label>
    <div class="modal-btns">
      <button class="btn btn-cancel" onclick="closeModal('editRevisitModal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="updateRevisit()">ì €ì¥</button>
      <button class="btn btn-danger" onclick="deleteRevisit()">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// CONFIG â€” í† í°ì€ ì½”ë“œì— ì—†ìŒ. localStorageì—ì„œ ë¶ˆëŸ¬ì˜´
// ============================================================
const CONFIG = {
  owner: 'corin1922',  // â† ë³¸ì¸ GitHub ì•„ì´ë””ë¡œ ë³€ê²½
  repo: 'Service-report',
  branch: 'main',
  users: {
    user1: { username: 'Kim Hyeonsoo' },  // â† ì‹¤ì œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
    user2: { username: 'Jo Kyeongeun' }       // â† ì‹¤ì œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
  }
};

// ============================================================
// í˜„ì¬ ì‚¬ìš©ì ê²°ì • (URL íŒŒë¼ë¯¸í„° ?user=user1 or user2)
// ============================================================
const urlParams = new URLSearchParams(window.location.search);
const currentUser = (['user1','user2'].includes(urlParams.get('user')))
  ? urlParams.get('user')
  : 'user1';

const USERNAME = CONFIG.users[currentUser].username;

// ì‚¬ìš©ìë³„ ë°ì´í„° ê²½ë¡œ (GitHub)
const RECORDS_PATH = `data/${currentUser}_records.json`;
const REVISIT_PATH = `data/${currentUser}_revisit.json`;

// ì‚¬ìš©ìë³„ localStorage í‚¤
const RECORDS_KEY = `jw_records_${currentUser}`;
const REVISIT_KEY = `jw_revisit_${currentUser}`;
const TOKEN_KEY   = 'jw_github_token';

// í† í°ì€ localStorageì—ì„œ ë¶ˆëŸ¬ì˜´ (ì½”ë“œì— ì—†ìŒ)
function getToken() { return localStorage.getItem(TOKEN_KEY) || ''; }
function saveToken() {
  const val = document.getElementById('tokenInput').value.trim();
  if (!val.startsWith('ghp_') && !val.startsWith('github_pat_')) {
    showToast('âš ï¸ ì˜¬ë°”ë¥¸ í† í° í˜•ì‹ì´ ì•„ë‹ˆì—ìš” (ghp_ ë¡œ ì‹œì‘í•´ì•¼ í•´ìš”)');
    return;
  }
  localStorage.setItem(TOKEN_KEY, val);
  document.getElementById('tokenScreen').classList.remove('show');
  showToast('âœ… í† í°ì´ ì €ì¥ëì–´ìš”. ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  initApp();
}
function resetToken() {
  if (!confirm('ë¡œê·¸ì•„ì›ƒì„ í•˜ë©´ í† í°ì„ ë‹¤ì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?')) return;
  localStorage.removeItem(TOKEN_KEY);
  document.getElementById('tokenInput').value = '';
  document.getElementById('tokenScreen').classList.add('show');
}

// ============================================================
// DATA
// ============================================================
let serviceRecords = {};
let revisitData = [];

function loadLocal() {
  try {
    serviceRecords = JSON.parse(localStorage.getItem(RECORDS_KEY) || '{}');
    revisitData    = JSON.parse(localStorage.getItem(REVISIT_KEY)  || '[]');
  } catch(e) {
    serviceRecords = {};
    revisitData = [];
  }
}
function saveLocal() {
  localStorage.setItem(RECORDS_KEY, JSON.stringify(serviceRecords));
  localStorage.setItem(REVISIT_KEY,  JSON.stringify(revisitData));
}

// ============================================================
// GITHUB API
// ============================================================
async function githubGet(path) {
  const token = getToken();
  if (!token) return null;
  try {
    const r = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`, {
      headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' }
    });
    if (!r.ok) return null;
    const d = await r.json();
    return { content: JSON.parse(atob(d.content)), sha: d.sha };
  } catch(e) { return null; }
}
async function githubPut(path, content, sha) {
  const token = getToken();
  if (!token) return;
  const body = { message: `update ${path}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))), branch: CONFIG.branch };
  if (sha) body.sha = sha;
  await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`, {
    method: 'PUT', headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
}
let recordsSha = null, revisitSha = null;
async function loadFromGitHub() {
  const rec = await githubGet(RECORDS_PATH);
  if (rec) { serviceRecords = rec.content; recordsSha = rec.sha; }
  const rv  = await githubGet(REVISIT_PATH);
  if (rv)  { revisitData   = rv.content;  revisitSha  = rv.sha; }
}
async function saveToGitHub() {
  const recResult = await githubGet(RECORDS_PATH);
  recordsSha = recResult ? recResult.sha : null;
  await githubPut(RECORDS_PATH, serviceRecords, recordsSha);
  const rvResult = await githubGet(REVISIT_PATH);
  revisitSha = rvResult ? rvResult.sha : null;
  await githubPut(REVISIT_PATH, revisitData, revisitSha);
}

// ============================================================
// UTILS
// ============================================================
function today() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function getServiceYear(date) {
  const d = date || new Date();
  const m = d.getMonth() + 1; // 1-based
  const y = d.getFullYear();
  return m >= 9 ? y + 1 : y;
}

function monthName(m, lang) {
  const ko = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  const en = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const id = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  if (lang === 'en') return en[m-1];
  if (lang === 'id') return id[m-1];
  return ko[m-1];
}

// ============================================================
// INIT
// ============================================================
async function init() {
  document.getElementById('headerUser').textContent = USERNAME + 'ë‹˜';

  // í† í° ì—†ìœ¼ë©´ ì…ë ¥ í™”ë©´ í‘œì‹œ
  if (!getToken()) {
    document.getElementById('tokenScreen').classList.add('show');
    return;
  }
  await initApp();
}

async function initApp() {
  document.getElementById('headerUser').textContent = USERNAME + 'ë‹˜';
  loadLocal();
  initSelects();
  setDefaultDate();

  // GitHubì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  await loadFromGitHub();
  saveLocal();

  renderStats();
  renderServiceYear();
  renderCalendar();
  renderRevisitList();
}

function initSelects() {
  const now = new Date();
  const cy = now.getFullYear();
  const cm = now.getMonth() + 1;

  // statsYear, calYear, summaryYear
  ['statsYear','calYear','summaryYear'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    for (let y = cy - 3; y <= cy + 1; y++) {
      sel.innerHTML += `<option value="${y}" ${y===cy?'selected':''}>${y}ë…„</option>`;
    }
  });

  // statsMonth, calMonth, summaryMonth
  ['statsMonth','calMonth','summaryMonth'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    for (let m = 1; m <= 12; m++) {
      sel.innerHTML += `<option value="${m}" ${m===cm?'selected':''}>${m}ì›”</option>`;
    }
  });
}

function setDefaultDate() {
  document.getElementById('recordDate').value = today();
}

// ============================================================
// TAB SWITCH
// ============================================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', ['home','calendar','revisit'][i] === name);
  });
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
}

// ============================================================
// HOME â€” SAVE RECORD
// ============================================================
async function saveRecord() {
  const date  = document.getElementById('recordDate').value;
  const hours = parseInt(document.getElementById('recordHour').value);
  const mins  = parseInt(document.getElementById('recordMin').value);
  const study = document.getElementById('recordStudy').value;

  if (!date) { showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  if (hours === 0 && mins === 0) { showToast('ë´‰ì‚¬ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  serviceRecords[date] = { hours, minutes: mins, study: study ? parseInt(study) : 0 };
  saveLocal();
  await saveToGitHub();

  // reset
  document.getElementById('recordHour').value  = '0';
  document.getElementById('recordMin').value   = '0';
  document.getElementById('recordStudy').value = '';
  document.getElementById('recordDate').value  = today();

  renderStats();
  renderServiceYear();
  renderCalendar();
  showToast('âœ… ë´‰ì‚¬ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================
// HOME â€” STATS
// ============================================================
function renderStats() {
  const y = parseInt(document.getElementById('statsYear').value);
  const m = parseInt(document.getElementById('statsMonth').value);
  const { totalHours, totalRemMins, totalStudy } = getMonthTotals(y, m);
  const display = totalRemMins > 0 ? `${totalHours}h ${totalRemMins}m` : `${totalHours}`;
  document.getElementById('statHours').textContent = display;
  document.getElementById('statStudy').textContent = totalStudy;
}

function getMonthTotals(y, m) {
  let totalMins = 0, totalStudy = 0;
  Object.entries(serviceRecords).forEach(([date, rec]) => {
    const d = new Date(date);
    if (d.getFullYear() === y && d.getMonth() + 1 === m) {
      totalMins  += (rec.hours || 0) * 60 + (rec.minutes || 0);
      totalStudy += rec.study || 0;
    }
  });
  return { totalHours: Math.floor(totalMins / 60), totalRemMins: totalMins % 60, totalMins, totalStudy };
}

// ============================================================
// HOME â€” SEND REPORT
// ============================================================
function sendReport() {
  const y = parseInt(document.getElementById('statsYear').value);
  const m = parseInt(document.getElementById('statsMonth').value);
  const lang = document.querySelector('input[name="lang"]:checked').value;
  const { totalHours, totalStudy } = getMonthTotals(y, m);

  let text = '';
  if (lang === 'ko') {
    text = `${y}ë…„ ${m}ì›” ì•¼ì™¸ ë´‰ì‚¬ ë³´ê³ \n\n${USERNAME}\nì„±ì„œ ì—°êµ¬: ${totalStudy}\nì‹œê°„: ${totalHours}\në¹„ê³ : -`;
  } else if (lang === 'en') {
    text = `FIELD SERVICE REPORT ${monthName(m,'en')} ${y}\n\n${USERNAME}\nBible studies: ${totalStudy}\nHours: ${totalHours}\nComments: -`;
  } else {
    text = `LAPORAN DINAS LAPANGAN ${monthName(m,'id')} ${y}\n\n${USERNAME}\nPelajaran Alkitab: ${totalStudy}\nJam: ${totalHours}\nKeterangan: -`;
  }

  navigator.clipboard.writeText(text).then(() => {
    showToast('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
  }).catch(() => {
    showToast('ë³µì‚¬ ì‹¤íŒ¨ â€” ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”');
  });
}

// ============================================================
// HOME â€” SERVICE YEAR
// ============================================================
function renderServiceYear() {
  const now = new Date();
  const sy = getServiceYear(now);
  const startYear = sy - 1;
  const start = new Date(startYear, 8, 1); // Sep 1
  const end   = new Date(sy, 7, 31);       // Aug 31

  let totalMins = 0;
  Object.entries(serviceRecords).forEach(([date, rec]) => {
    const d = new Date(date);
    if (d >= start && d <= end) {
      totalMins += (rec.hours || 0) * 60 + (rec.minutes || 0);
    }
  });

  document.getElementById('serviceYearTitle').textContent = `${sy} ë´‰ì‚¬ ì—°ë„`;
  document.getElementById('serviceYearHours').textContent = Math.floor(totalMins / 60);
}

// ============================================================
// CALENDAR
// ============================================================
function renderCalendar() {
  const y = parseInt(document.getElementById('calYear').value);
  const m = parseInt(document.getElementById('calMonth').value);
  const grid = document.getElementById('calGrid');

  const todayStr = today();
  const firstDay = new Date(y, m - 1, 1).getDay(); // 0=Sun
  const daysInMonth = new Date(y, m, 0).getDate();

  let html = '';
  // Day labels
  ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((d,i) => {
    const cls = i===0?'sun':i===6?'sat':'';
    html += `<div class="cal-day-label ${cls}">${d}</div>`;
  });

  // Empty cells
  for (let i = 0; i < firstDay; i++) {
    html += `<div class="cal-day empty"></div>`;
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const rec = serviceRecords[dateStr];
    const isToday = dateStr === todayStr;
    const hasRec = !!rec;

    let infoHtml = '';
    if (rec) {
      const hStr = `${rec.hours}h ${rec.minutes}m`;
      infoHtml = `<div class="day-info">${hStr}`;
      if (rec.study > 0) infoHtml += `<br><span class="day-study">${rec.study}s</span>`;
      infoHtml += `</div>`;
    }

    html += `<div class="cal-day ${hasRec?'has-record':''} ${isToday?'today':''}" 
              onclick="openEditRecord('${dateStr}')">
              <div class="day-num">${d}</div>
              ${infoHtml}
             </div>`;
  }

  grid.innerHTML = html;
}

// ============================================================
// CALENDAR â€” EDIT RECORD MODAL
// ============================================================
let editingDate = null;

function openEditRecord(dateStr) {
  editingDate = dateStr;
  const rec = serviceRecords[dateStr] || { hours: 0, minutes: 0, study: 0 };

  document.getElementById('editDate').value  = dateStr;
  document.getElementById('editHour').value  = rec.hours || 0;
  document.getElementById('editMin').value   = rec.minutes || 0;
  document.getElementById('editStudy').value = rec.study   || '';

  openModal('editRecordModal');
}

async function updateRecord() {
  const hours = parseInt(document.getElementById('editHour').value);
  const mins  = parseInt(document.getElementById('editMin').value);
  const study = document.getElementById('editStudy').value;

  serviceRecords[editingDate] = { hours, minutes: mins, study: study ? parseInt(study) : 0 };
  saveLocal();
  await saveToGitHub();

  closeModal('editRecordModal');
  renderCalendar();
  renderStats();
  renderServiceYear();
  showToast('âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
}

async function deleteRecord() {
  if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  delete serviceRecords[editingDate];
  saveLocal();
  await saveToGitHub();

  closeModal('editRecordModal');
  renderCalendar();
  renderStats();
  renderServiceYear();
  showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================
// CALENDAR â€” MONTHLY SUMMARY
// ============================================================
function showMonthlySummary() {
  const y = parseInt(document.getElementById('summaryYear').value);
  const m = parseInt(document.getElementById('summaryMonth').value);
  const { totalHours, totalRemMins, totalStudy } = getMonthTotals(y, m);
  const display = totalRemMins > 0 ? `${totalHours}h ${totalRemMins}m` : `${totalHours}`;

  document.getElementById('summaryTitle').textContent = `${y}ë…„ ${m}ì›” í†µê³„`;
  document.getElementById('summaryHours').textContent = display;
  document.getElementById('summaryStudy').textContent = totalStudy;
  document.getElementById('summaryResult').style.display = 'block';
}

// ============================================================
// REVISIT
// ============================================================
function renderRevisitList() {
  const list = document.getElementById('revisitList');
  if (!revisitData.length) {
    list.innerHTML = '<div style="color:#999;font-size:14px;text-align:center;padding:20px 0">ì¬ë°©ë¬¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  // Sort: alphabet (English/Korean mixed)
  const sorted = [...revisitData].sort((a, b) => a.name.localeCompare(b.name, ['ko','en']));

  list.innerHTML = sorted.map(rv => {
    const icon = rv.study ? 'ğŸ“– ' : '';
    return `<div class="revisit-item">
      <div class="revisit-name">${icon}${rv.name}</div>
      <button class="btn-sm primary" onclick="openEditRevisit('${rv.id}')">ë©”ëª¨</button>
      <button class="btn-sm danger" onclick="confirmDeleteRevisit('${rv.id}')">ì‚­ì œ</button>
    </div>`;
  }).join('');
}

async function saveRevisit() {
  const name  = document.getElementById('rvName').value.trim();
  const memo  = document.getElementById('rvMemo').value.trim();
  const study = document.getElementById('rvStudy').checked;

  if (!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  revisitData.push({ id: Date.now().toString(), name, memo, study });
  saveLocal();
  await saveToGitHub();

  document.getElementById('rvName').value  = '';
  document.getElementById('rvMemo').value  = '';
  document.getElementById('rvStudy').checked = false;

  renderRevisitList();
  showToast('âœ… ì¬ë°©ë¬¸ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

let editingRevisitId = null;

function openEditRevisit(id) {
  const rv = revisitData.find(r => r.id === id);
  if (!rv) return;
  editingRevisitId = id;
  document.getElementById('editRvName').value     = rv.name;
  document.getElementById('editRvMemo').value     = rv.memo || '';
  document.getElementById('editRvStudy').checked  = rv.study || false;
  openModal('editRevisitModal');
}

async function updateRevisit() {
  const idx = revisitData.findIndex(r => r.id === editingRevisitId);
  if (idx === -1) return;

  revisitData[idx] = {
    ...revisitData[idx],
    name:  document.getElementById('editRvName').value.trim(),
    memo:  document.getElementById('editRvMemo').value.trim(),
    study: document.getElementById('editRvStudy').checked
  };
  saveLocal();
  await saveToGitHub();

  closeModal('editRevisitModal');
  renderRevisitList();
  showToast('âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
}

async function deleteRevisit() {
  if (!confirm('ì´ ì¬ë°©ë¬¸ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  revisitData = revisitData.filter(r => r.id !== editingRevisitId);
  saveLocal();
  await saveToGitHub();

  closeModal('editRevisitModal');
  renderRevisitList();
  showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

async function confirmDeleteRevisit(id) {
  if (!confirm('ì´ ì¬ë°©ë¬¸ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  revisitData = revisitData.filter(r => r.id !== id);
  saveLocal();
  await saveToGitHub();
  renderRevisitList();
  showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// Close modals on backdrop click
document.querySelectorAll('.modal-backdrop').forEach(bd => {
  bd.addEventListener('click', e => { if (e.target === bd) bd.classList.remove('open'); });
});

// ============================================================
// START
// ============================================================
init();
</script>
</body>
</html>
